
/**
 * 
 *
 * $Id: cmu_diags_c.stg,v 1.12 Broadcom SDK $    
 * $Copyright: (c) 2016 Broadcom.
 * Broadcom Proprietary and Confidential. All rights reserved.$
 * 
 *
 * t3p1_cmu_diags.c: Guadalupe2k V1.3 microcode diagnostics routines 
 *
 * This file provides the public interface to the Guadalupe2k V1.3
 * microcode.  Only explicitly documented elements (types  & functions)
 * are supported, external interfaces.  Other elements are exported only
 * for debugging convenience.
 *
 * DO NOT EDIT THIS FILE!
 * This file is auto-generated.
 * Edits to this file will be lost when it is regenerated.
 */
#if defined(BCM_CALADAN3_SUPPORT) && defined(BCM_CALADAN3_T3P1_SUPPORT)
#include <shared/bsl.h>

#include <soc/sbx/t3p1/t3p1_int.h>
#include <soc/sbx/t3p1/t3p1_defs.h>
#include <soc/sbx/t3p1/t3p1_cmu.h>
#include <soc/sbx/t3p1/t3p1_diags.h>
#include <soc/sbx/t3p1/t3p1_cmu_diags.h>
#include <appl/diag/system.h>

#include <ctype.h>

void soc_sbx_t3p1_example_counters_print(int unit, uint32 start_counter, uint32 num_counters) {
    int rv, i;
    soc_sbx_t3p1_turbo64_count_t *counter_values;
    
    counter_values = sal_alloc(num_counters * sizeof(soc_sbx_t3p1_turbo64_count_t), "asm3_cmu_diags");
    if (counter_values == NULL) {
    	 cli_out("soc_sbx_t3p1_example_counters_print: Could not sal_alloc for %d counters", num_counters);
        return;
    }

    rv = soc_sbx_t3p1_example_counters_read(unit, start_counter, num_counters, FALSE, counter_values);
    if (rv != SOC_E_NONE) {
    	 cli_out("soc_sbx_t3p1_example_counters_print: soc_sbx_t3p1_example_counters_read failure");
        sal_free(counter_values);
        return;
    }
	cli_out("example_counters\n");
    for (i=0; i<num_counters; i++) {   
    	char buf1_val[32];
    	char buf2_val[32];
    	format_uint64_decimal(buf1_val, counter_values[i].packets, 0);
    	format_uint64_decimal(buf2_val, counter_values[i].bytes, 0);
    	cli_out("\t%d: [Packets: %s Bytes: %s]\n", start_counter+i, buf1_val, buf2_val);
    }
    cli_out("\n");
    sal_free(counter_values);
}

void soc_sbx_t3p1_example_counters_reset(int unit) {
    int rv;

    rv = soc_sbx_t3p1_example_counters_clear(unit);
    if (rv != SOC_E_NONE) {
    	 cli_out("soc_sbx_t3p1_example_counters_reset: soc_sbx_t3p1_example_counters_clear failure");
        return;
    }
}

    
void soc_sbx_t3p1_rtctr_print(int unit, uint32 start_counter, uint32 num_counters) {
    int rv, i;
    soc_sbx_t3p1_turbo64_count_t *counter_values;
    
    counter_values = sal_alloc(num_counters * sizeof(soc_sbx_t3p1_turbo64_count_t), "asm3_cmu_diags");
    if (counter_values == NULL) {
    	 cli_out("soc_sbx_t3p1_rtctr_print: Could not sal_alloc for %d counters", num_counters);
        return;
    }

    rv = soc_sbx_t3p1_rtctr_read(unit, start_counter, num_counters, FALSE, counter_values);
    if (rv != SOC_E_NONE) {
    	 cli_out("soc_sbx_t3p1_rtctr_print: soc_sbx_t3p1_rtctr_read failure");
        sal_free(counter_values);
        return;
    }

    cli_out("rtctr\n"); 
    for (i=0; i<num_counters; i++) {      
        char buf1_val[32];
        char buf2_val[32];
        format_uint64_decimal(buf1_val, counter_values[i].packets, 0);
        format_uint64_decimal(buf2_val, counter_values[i].bytes, 0);
        cli_out("\t%d: [Packets: %s Bytes: %s]\n", start_counter+i, buf1_val, buf2_val);
    }
    cli_out("\n");
    sal_free(counter_values);
}

void soc_sbx_t3p1_rtctr_reset(int unit) {
    int rv;

    rv = soc_sbx_t3p1_rtctr_clear(unit);
    if (rv != SOC_E_NONE) {
    	 cli_out("soc_sbx_t3p1_rtctr_reset: soc_sbx_t3p1_rtctr_clear failure");
        return;
    }
}


static int parse_num_in_str(char *str) {
    char *sptr;
    sptr = str;
    while ((*sptr != (char)0) && (!isdigit((int)*sptr))) {
        sptr++;
    }

    return _shr_ctoi(sptr);   
}

/*
 * Diag shell print driver implementation
 */
int soc_sbx_t3p1_cmu_shell_print(int unit, int argc, char **argv)
{    
    int start_counter = 0;
    int num_counters = 0;

    if (!sal_strcasecmp(argv[0], "example_counters")) {
        if (argc < 2)
            return SOC_E_PARAM;

        start_counter = parse_num_in_str(argv[1]);
        if (argc == 3) {
            num_counters = parse_num_in_str(argv[2]);
        }
        else {
            num_counters = 50 - num_counters;
        }

        cli_out("soc_sbx_t3p1_example_counters_print(%d, %d)\n", start_counter, num_counters);
        soc_sbx_t3p1_example_counters_print(unit, start_counter, num_counters);
        return SOC_E_NONE;
    }
    if (!sal_strcasecmp(argv[0], "rtctr")) {
        if (argc < 2)
            return SOC_E_PARAM;

        start_counter = parse_num_in_str(argv[1]);
        if (argc == 3) {
            num_counters = parse_num_in_str(argv[2]);
        }
        else {
            num_counters = 50 - num_counters;
        }

        cli_out("soc_sbx_t3p1_rtctr_print(%d, %d)\n", start_counter, num_counters);
        soc_sbx_t3p1_rtctr_print(unit, start_counter, num_counters);
        return SOC_E_NONE;
    }

    return SOC_E_PARAM;
}


/*
 * Diag shell set driver implementation
 */
int soc_sbx_t3p1_cmu_shell_reset(int unit, int argc, char **argv)
{
    if (!sal_strcasecmp(argv[0], "example_counters")) {
        soc_sbx_t3p1_example_counters_reset(unit);
        return SOC_E_NONE;
    }
    if (!sal_strcasecmp(argv[0], "rtctr")) {
        soc_sbx_t3p1_rtctr_reset(unit);
        return SOC_E_NONE;
    }


    return SOC_E_PARAM;
}


char soc_sbx_t3p1_cmu_get_usage[] = 
"t3p1cmuget <counter group> [from=<i0> num=<i1>...]\n"
"         counter group : example_counters rtctr   \n"                                               
;

char soc_sbx_t3p1_cmu_reset_usage[] = 
"t3p1cmureset <counter group> \n"
"         counter group : example_counters rtctr   \n"    
;

#endif
