
/*
 *         
 * 
 * 
 * This license is set out in https://raw.githubusercontent.com/Broadcom-Network-Switching-Software/OpenBCM/master/Legal/LICENSE file.
 * 
 * Copyright 2007-2021 Broadcom Inc. All rights reserved.
 *         
 *     
 * DO NOT EDIT THIS FILE!
 */

#include <bcm/port.h>
#include <bcm_int/dnx/port/imb/imb_common.h>
#include <bcm_int/dnx/port/imb/imb_internal.h>
#include <bcm_int/dnx/port/nif/dnx_port_nif_arb.h>
#include <bcm_int/dnx/port/nif/dnx_port_nif_ofr.h>
#include <bcm_int/dnx/port/nif/dnx_port_nif_oft.h>
#include <soc/portmod/portmod.h>
#include <soc/dnx/swstate/auto_generated/access/dnx_port_imb_access.h>
#include <soc/dnx/swstate/auto_generated/types/dnx_port_imb_types.h>
#include <shared/shrextend/shrextend_debug.h>
#include <bcm_int/dnx/port/imb/imb.h>
#include <bcm_int/dnx/port/imb/imb_dispatch.h>

#ifdef INCLUDE_XFLOW_MACSEC
#include <dnx/dnx_sec.h>
#include <soc/dnx/dnx_data/auto_generated/dnx_data_macsec.h>
#endif

#ifdef BSL_LOG_MODULE
#error "BSL_LOG_MODULE redefined"
#endif
#define BSL_LOG_MODULE BSL_LS_BCMDNX_PORT

#ifdef BCM_DNX2_SUPPORT

int
imb_cdu_shr_init(
    int unit,
    const imb_create_info_t * imb_info,
    imb_specific_create_info_t * imb_specific_info)
{
    SHR_FUNC_INIT_VARS(unit);

    /*
     * Place your code here 
     */

    SHR_FUNC_EXIT;

}

int
imb_cdu_shr_deinit(
    int unit,
    const imb_create_info_t * imb_info,
    imb_specific_create_info_t * imb_specific_info)
{
    SHR_FUNC_INIT_VARS(unit);

    /*
     * Place your code here 
     */

    SHR_FUNC_EXIT;

}

int
imb_cdu_shr_port_attach(
    int unit,
    bcm_port_t port,
    uint32 flags)
{
    SHR_FUNC_INIT_VARS(unit);

    /*
     * Adding shared blocks
     */
    SHR_IF_ERR_EXIT(dnx_port_arb_port_add(unit, port));
    SHR_IF_ERR_EXIT(dnx_port_ofr_port_add(unit, port));
    SHR_IF_ERR_EXIT(dnx_port_oft_port_add(unit, port));

#ifdef INCLUDE_XFLOW_MACSEC
    if (dnx_data_macsec.general.feature_get(unit, dnx_data_macsec_general_macsec_block_exists))
    {
        /** enable the MACSec core clk */
        SHR_IF_ERR_EXIT(dnx_xflow_macsec_shared_macsec_core_power_down_set(unit, 0));
    }
#endif

exit:
    SHR_FUNC_EXIT;
}

int
imb_cdu_shr_port_detach(
    int unit,
    bcm_port_t port)
{
    SHR_FUNC_INIT_VARS(unit);

    /*
     * Removing shared blocks
     */
    SHR_IF_ERR_EXIT(dnx_port_arb_port_remove(unit, port));
    SHR_IF_ERR_EXIT(dnx_port_ofr_port_remove(unit, port));
    SHR_IF_ERR_EXIT(dnx_port_oft_port_remove(unit, port));

#ifdef INCLUDE_XFLOW_MACSEC
    if (dnx_data_macsec.general.feature_get(unit, dnx_data_macsec_general_macsec_block_exists))
    {
        /*
         * handle MACSec clean up
         */
        SHR_IF_ERR_EXIT(imb_common_port_macsec_port_enable_set(unit, port, 0 /** disable */ ));

        /*
         * disable the MACSec core clk ONLY in case this is the last port in the entire MACSec instance.
         */
        SHR_IF_ERR_EXIT(dnx_xflow_macsec_shared_macsec_core_power_down_set(unit, 1));
    }
#endif
exit:
    SHR_FUNC_EXIT;
}

int
imb_cdu_shr_port_enable_set(
    int unit,
    bcm_port_t port,
    uint32 flags,
    int enable)
{
    SHR_FUNC_INIT_VARS(unit);

    /*
     * Enable port in Arb. Rx
     */
    SHR_IF_ERR_EXIT(dnx_port_arb_port_enable(unit, port, ARB_RX_DIRECTION, enable));

    /*
     * Enable port in OFR
     */
    SHR_IF_ERR_EXIT(dnx_port_ofr_port_enable(unit, port, enable));

    /*
     * Enable port in Arb. TX
     */
    SHR_IF_ERR_EXIT(dnx_port_arb_port_enable(unit, port, ARB_TX_DIRECTION, enable));
    /*
     * Enable credits in Arb. Tx
     */
    SHR_IF_ERR_EXIT(dnx_port_arb_credits_init(unit, port, enable));

    /*
     * Enable port in OFT
     */
    SHR_IF_ERR_EXIT(dnx_port_oft_port_enable_set(unit, port, enable));

exit:
    SHR_FUNC_EXIT;

}

int
imb_cdu_shr_port_enable_get(
    int unit,
    bcm_port_t port,
    int *enable)
{
    SHR_FUNC_INIT_VARS(unit);

    
    /*
     * SHR_IF_ERR_EXIT(portmod_port_enable_get(unit, port, 0, enable));
     */

    SHR_FUNC_EXIT;

}

#endif /* BCM_DNX2_SUPPORT */

#undef BSL_LOG_MODULE
