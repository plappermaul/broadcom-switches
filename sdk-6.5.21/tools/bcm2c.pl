# $Id: bcm2c.pl,v 1.3 2011/04/12 09:05:28 sraj Exp $
#
# This license is set out in https://raw.githubusercontent.com/Broadcom-Network-Switching-Software/OpenBCM/master/Legal/LICENSE file.
# 
# Copyright 2007-2020 Broadcom Inc. All rights reserved.
#
# bcm2c - compile config.bcm into static code.
#The script will first compile the main .bcm file (given as the input argument to the script) and then will continue with the compilation of all imported files to it.
#Example: perl $SDK/tools/bcm2c.pl $SDK/rc/config-dcmn.bcm > onfig_init_defaults.c
use File::Basename;

sub parse_file
{
    open (BCMFILE, $_[0] || die " bcm2c: could not open .bcm file[$_[0]]\n");

    my @imports = ();
    while (<BCMFILE>)
    {
        next if /#/;
        # save all imported file paths.
        if ($_ =~ /import/)
        {
            ($command,$file) = split(" ");
            #Sanity check.
            if ($command != "import")
            {
                die " bcm2c: Something went wrong while importing a bcm file.\n";
            }
            #save the path of the imported file
            push @imports, "${dirname}/${file}";
        }
        # Split the line to attribute and value
        ($attr,$val) = split(/=/);
        chop $val;
        if(($attr ne "") && ($val ne ""))
        {
            printf("    sal_config_set(\"$attr\",\"$val\");\n");
            $n_vars++;
        }
    }

    # call parse_file for all imported files.
    while(@imports)
    {
        $file = shift(@imports);
        parse_file($file);
    }
}

$|=1;

print <<'EOT';
/*
 * This file is automatically generated by bcm2c.pl.  DO NOT EDIT!
 */
#include <sal/appl/config.h>
EOT
$n_vars = 0;
#get the directory of the bcm file. It will be used for the imported files.
$dirname = dirname($ARGV[0]);
printf("void\nsal_config_init_defaults(void)\n{\n");
parse_file($ARGV[0]);
print "}\n";